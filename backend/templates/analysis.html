{% extends "base.html" %}

{% block content %}
<div class="bg-white rounded-lg shadow p-6">
    <h2 class="text-2xl font-bold mb-4">Market Analysis</h2>
    <p class="text-gray-600 mb-4">Search for funds or stocks to analyze historical performance.</p>

    <div class="relative max-w-xl">
        <input type="text" id="analysisSearch" placeholder="Search asset..." class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
        <div id="analysisResults" class="absolute z-10 bg-white shadow-lg w-full mt-1 rounded hidden border"></div>
    </div>

    <div id="assetDetails" class="mt-8 hidden">
        <h3 id="assetName" class="text-xl font-bold"></h3>
        <p id="assetMeta" class="text-gray-500 mb-4"></p>
        <!-- Chart placeholder for future implementation -->
        <div class="h-64 bg-gray-100 rounded flex items-center justify-center text-gray-500">
            Chart Visualization (Coming Soon)
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const searchInput = document.getElementById('analysisSearch');
    const resultsDiv = document.getElementById('analysisResults');
    const assetDetails = document.getElementById('assetDetails');
    const assetName = document.getElementById('assetName');
    const assetMeta = document.getElementById('assetMeta');
    let timeoutId;

    searchInput.addEventListener('input', (e) => {
        clearTimeout(timeoutId);
        const q = e.target.value;
        if (q.length < 2) {
            resultsDiv.classList.add('hidden');
            return;
        }

        timeoutId = setTimeout(async () => {
            // Show loading indicator
            resultsDiv.classList.remove('hidden');
            resultsDiv.innerHTML = `
                <div class="p-3 text-gray-500 text-center">
                    <i class="fas fa-spinner fa-spin mr-2"></i> Searching...
                </div>
            `;

            const res = await fetch(`/api/search?q=${q}`);
            const data = await res.json();

            resultsDiv.innerHTML = '';
            if (data.length > 0) {
                resultsDiv.classList.remove('hidden');
                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'p-3 hover:bg-gray-100 cursor-pointer border-b';
                    div.innerHTML = `
                        <div class="font-bold">${item.symbol}</div>
                        <div class="text-sm text-gray-600">${item.name}</div>
                        <div class="text-xs text-gray-500">${item.type} | ${item.currency}</div>
                    `;
                    div.addEventListener('click', () => {
                        showAsset(item);
                        resultsDiv.classList.add('hidden');
                        searchInput.value = item.symbol;
                    });
                    resultsDiv.appendChild(div);
                });
            } else {
                resultsDiv.classList.add('hidden');
            }
        }, 300);
    });

    function showAsset(item) {
        assetDetails.classList.remove('hidden');
        assetName.textContent = `${item.symbol} - ${item.name}`;
        assetMeta.textContent = `Type: ${item.type} | Currency: ${item.currency} | Exchange: ${item.exchange || 'N/A'}`;
    }
</script>
{% endblock %}
